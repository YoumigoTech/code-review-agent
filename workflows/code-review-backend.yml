# Code Review Workflow for Backend (Python/FastAPI)

name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '**.sql'
      - 'requirements*.txt'
      - 'pyproject.toml'

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  risk-scan:
    name: Risk Classification Scan
    runs-on: ubuntu-latest
    outputs:
      has_a_class_risks: ${{ steps.parse.outputs.has_a_class_risks }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.py
            **/*.sql

      - name: Fetch review rules
        id: fetch-rules
        run: |
          mkdir -p .review-rules

          # Fetch with error handling
          curl -sfL https://raw.githubusercontent.com/YoumigoTech/code-review-agent/main/rules/a-class-risks.md -o .review-rules/a-class-risks.md || { echo "::error::Failed to fetch a-class-risks.md"; exit 1; }
          curl -sfL https://raw.githubusercontent.com/YoumigoTech/code-review-agent/main/rules/b-class-risks.md -o .review-rules/b-class-risks.md || { echo "::error::Failed to fetch b-class-risks.md"; exit 1; }
          curl -sfL https://raw.githubusercontent.com/YoumigoTech/code-review-agent/main/rules/python-patterns.md -o .review-rules/python-patterns.md || { echo "::error::Failed to fetch python-patterns.md"; exit 1; }

          # Read rules into environment variables (escape for GitHub Actions)
          {
            echo "A_CLASS_RULES<<EOF"
            cat .review-rules/a-class-risks.md
            echo "EOF"
          } >> $GITHUB_ENV

          {
            echo "B_CLASS_RULES<<EOF"
            cat .review-rules/b-class-risks.md
            echo "EOF"
          } >> $GITHUB_ENV

          {
            echo "PYTHON_PATTERNS<<EOF"
            cat .review-rules/python-patterns.md
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Run AI Code Review
        id: scan
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          timeout_minutes: 10
          direct_prompt: |
            You are a code review agent. Analyze the following PR diff and classify risks.

            ## Risk Classification Rules

            ### A-Class Risks (BLOCKING - require human approval)
            ${{ env.A_CLASS_RULES }}

            ### B-Class Risks (NON-BLOCKING - suggestions only)
            ${{ env.B_CLASS_RULES }}

            ### Python-Specific Patterns
            ${{ env.PYTHON_PATTERNS }}

            ## Changed Files
            ${{ steps.changed-files.outputs.all_changed_files }}

            ## Instructions

            1. Analyze each changed file for A-class and B-class risks
            2. For each risk found, output in this exact format:

            ### A-Class Risks Found

            If any A-class risks are found:
            ```
            RISK_LEVEL: A
            FILE: <filepath>
            LINE: <line_number>
            TYPE: <A1-A6>
            DESCRIPTION: <description>
            RECOMMENDATION: <how to fix>
            ```

            ### B-Class Risks Found

            For B-class risks, output GitHub suggestion comments:
            ```
            RISK_LEVEL: B
            FILE: <filepath>
            LINE: <line_number>
            TYPE: <B1-B6>
            DESCRIPTION: <description>
            SUGGESTION:
            \`\`\`suggestion
            <corrected code>
            \`\`\`
            ```

            ### Summary

            At the end, output a JSON block:
            ```json
            {"has_a_class_risks": true|false, "total_a_class": <count>, "total_b_class": <count>}
            ```

            Be thorough but avoid false positives. Only flag genuine risks.

      - name: Parse scan results
        id: parse
        env:
          SCAN_RESPONSE: ${{ steps.scan.outputs.response }}
        run: |
          # Parse JSON from response for more reliable detection
          if echo "$SCAN_RESPONSE" | grep -q '"has_a_class_risks": true'; then
            echo "has_a_class_risks=true" >> $GITHUB_OUTPUT
          elif echo "$SCAN_RESPONSE" | grep -q '"has_a_class_risks":true'; then
            echo "has_a_class_risks=true" >> $GITHUB_OUTPUT
          else
            echo "has_a_class_risks=false" >> $GITHUB_OUTPUT
          fi

      - name: Post review comments
        uses: actions/github-script@v7
        env:
          SCAN_RESPONSE: ${{ steps.scan.outputs.response }}
        with:
          script: |
            const response = process.env.SCAN_RESPONSE || 'No response from AI review';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## AI Code Review Results\n\n${response}`
            });

  block-on-a-class:
    name: A-Class Risk Gate
    runs-on: ubuntu-latest
    needs: risk-scan
    if: needs.risk-scan.outputs.has_a_class_risks == 'true'

    steps:
      - name: Block PR
        run: |
          echo "::error::A-Class risks detected. Human review required."
          echo ""
          echo "This PR contains A-Class risks that require human review."
          echo "Please review the AI Code Review comment and either:"
          echo "  1. Fix the identified risks"
          echo "  2. Add RISK-ACCEPTED comments with justification"
          echo "  3. Request exemption from a senior engineer"
          exit 1

  approve-no-risks:
    name: No A-Class Risks
    runs-on: ubuntu-latest
    needs: risk-scan
    if: needs.risk-scan.outputs.has_a_class_risks == 'false'

    steps:
      - name: Approve
        run: |
          echo "No A-Class risks detected. PR can proceed."
          echo "Please review any B-Class suggestions in the PR comments."
